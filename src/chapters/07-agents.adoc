
[background-color="hsl(50, 89%, 74%)"]
= Agents

== Qu'est ce qu'un Agent?

* Un noeud (ou *node*) est une machine prête à recevoir
des _builds_
* Step `agent` spécifie sur quel "noeud" exécuter des "stages".
* Une section `agent` globale *doit* être définie
(au niveau du block `pipeline`)
* On peut aussi définire des sections `agent` par "stage"

== Exercice - Agents

* Exécuter l'étape *Build* sur un agent
configuré avec le label `maven-jdk8`
* Exécuter l'étape *Test* sur un agent
configuré avec le label `java8`
* L'éditeur Blue Ocean est utilisable

== Solution - Agents

[source,groovy,subs="attributes"]
----
include::{pipeline-solutions}/06-Jenkinsfile-agents[]
----


== Exercise - Réutilisation Binaire

* But: réutiliser les binaires générés dans *Build*
* Action: "mise sur étagère": *Stash / Unstash*
* Modifier le Pipeline pour :
** "Stasher" le dossier `target`, à la fin de la phase *Build*
** "Unstasher" au début de la phase *Test*
* _Attention_, une limite de l'éditeur *Blue Ocean*
va être atteinte

== Solution - Réutilisation Binaire

* L'éditeur Blue Ocean ne supporte pas encore
le ré-ordonnancement de "stages"
** Mode textuel et/ou *Snippet Generator* à utiliser

[source,groovy,subs="attributes"]
----
include::{pipeline-solutions}/04-Jenkinsfile-stash-tests[]
----

== Post-Stage

* Section `post` :
** Contient des "steps" à exécuter
à la fin du Pipeline *ou* après une "stage"
** Divisé en "condition d'états":
`always`, `success`, `failure`, `changed`
* Chaque condition contient ses propres "steps"
* Pas _encore_ intégré dans l'éditeur Blue Ocean

== Exercice - Rapport de Tests Unitaires

* Si le "stage" *Build* échoue,
alors la tâche "archiveArtifacts" ne devrait pas être exécutée
** Même chose pour `stash`
* Les rapports de tests unitaires doivent être
publiés dans *tous* les cas après la phase *Build*
** Format Junit
** Stockés dans `target/{asterisk}{asterisk}/{asterisk}.xml`
* Utiliser la documentation:
** link:https://jenkins.io/doc/book/pipeline/syntax/#post[Post section on docs.jenkins.io]

== Solution - Rapport de Tests Unitaires

[source,groovy,subs="attributes"]
----
include::{pipeline-solutions}/05-Jenkinsfile-post-tests[]
----

== Exercice - Tests Parallèles

* *But:* Tester en parallèle l'application
sur java 7 et 8
* Mot clef `parallel` définissant un block contenant
des "stages"
* Agent `java7` pour le Test Java 7
* L'éditeur Blue Ocean est utilisable (et recommandé)

== Solution - Tests Parallèles

[source,groovy,subs="attributes"]
----
include::{pipeline-solutions}/07-Jenkinsfile-parallel-tests[]
----

== Agents avec Docker

* *But:* Usage de Docker pour faciliter la définition
des environements de build
* Le mot clef `agent` permet d'exécuter les "stages" dans
un container Docker, depuis une "image Docker",
ou depuis un `Dockerfile` (recette maison d'image Docker)
** link:https://jenkins.io/doc/book/pipeline/syntax/#agent[Directive Agent sur jenkins.io]

== Exercice - Agent Docker

* Exécuter le *Build* dans un containeur
basé sur le fichier `Dockerfile.build`
* Exécuter le *Test Java 8* dans un containeur
basé sur les images `maven:3-jdk-8-alpine`
* Trick: documentation manquante sur `filename`,
dans un block `dockerfile`

== Solution - Agent Docker

[source,groovy,subs="attributes"]
----
include::{pipeline-solutions}/08-Jenkinsfile-dockerfile-agents[]
----
